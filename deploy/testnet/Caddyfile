# Basalt — Caddy reverse proxy
# Cloudflare Tunnel terminates HTTPS. Caddy handles routing, CORS, and headers.
# Two domains: basalt.foundation (website) and testnet.basalt.foundation (testnet).

# ─── Website (basalt.foundation) ───────────────────────────────────
:80 {
	# Match website domain first; fall through to testnet for other hosts
	@website host basalt.foundation
	handle @website {
		reverse_proxy website:80
	}

	# ─── Testnet (testnet.basalt.foundation or any other host) ─────

	# REST API
	handle /v1/* {
		reverse_proxy validator-0:5000
	}

	# GraphQL
	handle /graphql {
		reverse_proxy validator-0:5000
	}

	# WebSocket
	handle /ws/* {
		reverse_proxy validator-0:5000
	}

	# Health check
	handle /health {
		reverse_proxy validator-0:5000 {
			rewrite /v1/status
		}
	}

	# Block Explorer (Blazor WASM served by nginx)
	handle {
		reverse_proxy explorer:80
	}

	# Security headers
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		Referrer-Policy strict-origin-when-cross-origin
		-Server
	}

	# CORS
	header Access-Control-Allow-Origin *
	header Access-Control-Allow-Methods "GET, POST, OPTIONS"
	header Access-Control-Allow-Headers "Content-Type"
}
