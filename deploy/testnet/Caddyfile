# Basalt — Caddy reverse proxy
# Cloudflare Tunnel terminates HTTPS. Caddy handles routing, CORS, and headers.
# Two domains: basalt.foundation (website) and testnet.basalt.foundation (testnet).

(security_headers) {
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		Referrer-Policy strict-origin-when-cross-origin
		-Server
	}
	header Access-Control-Allow-Origin *
	header Access-Control-Allow-Methods "GET, POST, OPTIONS"
	header Access-Control-Allow-Headers "Content-Type"
}

# ─── Website (basalt.foundation) ───────────────────────────────────
http://basalt.foundation {
	reverse_proxy website:80
	import security_headers
}

# ─── Testnet (testnet.basalt.foundation or any other host) ─────────
:80 {
	# REST API
	handle /v1/* {
		reverse_proxy validator-0:5000
	}

	# GraphQL
	handle /graphql {
		reverse_proxy validator-0:5000
	}

	# WebSocket
	handle /ws/* {
		reverse_proxy validator-0:5000
	}

	# Health check
	handle /health {
		reverse_proxy validator-0:5000 {
			rewrite /v1/status
		}
	}

	# Block Explorer (Blazor WASM served by nginx)
	handle {
		reverse_proxy explorer:80
	}

	import security_headers
}
