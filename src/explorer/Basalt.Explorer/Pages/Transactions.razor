@page "/transactions"
@inject BasaltApiClient Api
@inject NavigationManager Nav

<PageTitle>Basalt Explorer - Transactions</PageTitle>

<div class="card">
    <div class="card-header">
        Recent Transactions
        <button class="badge badge-success" style="cursor:pointer; border:none" @onclick="LoadTransactions">Refresh</button>
    </div>
    <div class="card-body">
        <div class="filter-bar">
            <select class="filter-select" value="@_typeFilter" @onchange="OnFilterChanged">
                <option value="">All Types</option>
                <option value="Transfer">Transfer</option>
                <option value="ContractDeploy">Contract Deploy</option>
                <option value="ContractCall">Contract Call</option>
                <option value="StakeDelegate">Stake Delegate</option>
                <option value="StakeUnbond">Stake Unbond</option>
                <option value="ValidatorRegister">Validator Register</option>
            </select>
        </div>

        @if (_transactions != null && _transactions.Length > 0)
        {
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Hash</th>
                        <th>Block</th>
                        <th>Type</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tx in _transactions)
                    {
                        <tr @onclick="() => NavigateToTx(tx.Hash)" style="cursor:pointer">
                            <td data-label="Hash" class="hash truncate">@FormatHelper.TruncateHash(tx.Hash)</td>
                            <td data-label="Block">
                                @if (tx.BlockNumber.HasValue)
                                {
                                    <span class="hash link" @onclick="() => NavigateToBlock(tx.BlockNumber.Value)" @onclick:stopPropagation="true">@tx.BlockNumber</span>
                                }
                            </td>
                            <td data-label="Type"><span class="badge @FormatHelper.GetTxTypeBadgeClass(tx.Type)">@FormatHelper.GetTxTypeLabel(tx.Type)</span></td>
                            <td data-label="From" class="hash truncate">@FormatHelper.TruncateHash(tx.Sender)</td>
                            <td data-label="To" class="hash truncate">@FormatHelper.TruncateHash(tx.To)</td>
                            <td data-label="Value">@FormatHelper.FormatBslt(tx.Value)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else if (_loading)
        {
            <div class="loading">Loading transactions...</div>
        }
        else
        {
            <div class="empty-state">No transactions found.</div>
        }
    </div>
</div>

@code {
    private TransactionDto[]? _allTransactions;
    private TransactionDto[]? _transactions;
    private string _typeFilter = "";
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        _allTransactions = await Api.GetRecentTransactionsAsync();
        _transactions = _allTransactions;
        _loading = false;
    }

    private async Task LoadTransactions()
    {
        _loading = true;
        _allTransactions = await Api.GetRecentTransactionsAsync();
        ApplyFilter();
        _loading = false;
    }

    private void OnFilterChanged(ChangeEventArgs e)
    {
        _typeFilter = e.Value?.ToString() ?? "";
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        if (string.IsNullOrEmpty(_typeFilter))
        {
            _transactions = _allTransactions;
        }
        else
        {
            _transactions = _allTransactions?.Where(tx => tx.Type == _typeFilter).ToArray();
        }
    }

    private void NavigateToTx(string hash) => Nav.NavigateTo("/tx/" + hash);

    private void NavigateToBlock(ulong number) => Nav.NavigateTo("/block/" + number);

    private void NavigateToAccount(string address) => Nav.NavigateTo("/account/" + address);
}
