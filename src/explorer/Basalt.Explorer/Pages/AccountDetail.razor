@page "/account/{Address}"
@inject BasaltApiClient Api
@inject NavigationManager Nav

<PageTitle>Basalt Explorer - Account</PageTitle>

<div class="card">
    <div class="card-header">
        @if (_account != null && string.Equals(_account.AccountType, "Contract", StringComparison.OrdinalIgnoreCase))
        {
            <span>Contract Account</span>
        }
        else
        {
            <span>Account Details</span>
        }
    </div>
    <div class="card-body">
        @if (_account != null)
        {
            <div class="detail-row">
                <span class="detail-label">Address</span>
                <span class="detail-value hash-static">@_account.Address</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Balance</span>
                <span class="detail-value">@FormatHelper.FormatBslt(_account.Balance)</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Nonce</span>
                <span class="detail-value">@_account.Nonce</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Account Type</span>
                <span class="detail-value">
                    @if (string.Equals(_account.AccountType, "Contract", StringComparison.OrdinalIgnoreCase))
                    {
                        <span class="badge badge-deploy">Contract</span>
                    }
                    else
                    {
                        <span class="badge badge-default">@_account.AccountType</span>
                    }
                </span>
            </div>
        }
        else if (_error != null)
        {
            <div class="error-message">@_error</div>
        }
        else
        {
            <div class="loading">Loading account...</div>
        }
    </div>
</div>

@if (_transactions != null && _transactions.Length > 0)
{
    <div class="card" style="margin-top: 1.5rem">
        <div class="card-header">Account Transactions</div>
        <div class="card-body">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Hash</th>
                        <th>Block</th>
                        <th>Type</th>
                        <th>Direction</th>
                        <th>Counterparty</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tx in _transactions)
                    {
                        var isOutgoing = IsOutgoing(tx);
                        <tr @onclick="() => NavigateToTx(tx.Hash)" style="cursor:pointer">
                            <td class="hash truncate">@FormatHelper.TruncateHash(tx.Hash)</td>
                            <td>
                                @if (tx.BlockNumber.HasValue)
                                {
                                    <span class="hash" @onclick="() => NavigateToBlock(tx.BlockNumber.Value)" @onclick:stopPropagation="true">@tx.BlockNumber</span>
                                }
                            </td>
                            <td>
                                <span class="badge @FormatHelper.GetTxTypeBadgeClass(tx.Type)">@FormatHelper.GetTxTypeLabel(tx.Type)</span>
                            </td>
                            <td>
                                @if (isOutgoing)
                                {
                                    <span class="direction-badge outgoing">OUT</span>
                                }
                                else
                                {
                                    <span class="direction-badge incoming">IN</span>
                                }
                            </td>
                            <td>
                                @if (isOutgoing)
                                {
                                    <span class="hash truncate" @onclick="() => NavigateToAccount(tx.To)" @onclick:stopPropagation="true">@FormatHelper.TruncateHash(tx.To)</span>
                                }
                                else
                                {
                                    <span class="hash truncate" @onclick="() => NavigateToAccount(tx.Sender)" @onclick:stopPropagation="true">@FormatHelper.TruncateHash(tx.Sender)</span>
                                }
                            </td>
                            <td>@FormatHelper.FormatBslt(tx.Value)</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    [Parameter] public string Address { get; set; } = "";

    private AccountDto? _account;
    private TransactionDto[]? _transactions;
    private string? _error;

    protected override async Task OnParametersSetAsync()
    {
        _account = null;
        _transactions = null;
        _error = null;

        try
        {
            _account = await Api.GetAccountAsync(Address);
            if (_account == null)
            {
                _error = "Account not found: " + Address;
                return;
            }

            _transactions = await Api.GetAccountTransactionsAsync(Address, 25);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private bool IsOutgoing(TransactionDto tx)
    {
        return string.Equals(tx.Sender, Address, StringComparison.OrdinalIgnoreCase);
    }

    private void NavigateToTx(string hash)
    {
        Nav.NavigateTo("/tx/" + hash);
    }

    private void NavigateToBlock(ulong number)
    {
        Nav.NavigateTo("/block/" + number);
    }

    private void NavigateToAccount(string address)
    {
        Nav.NavigateTo("/account/" + address);
    }
}
